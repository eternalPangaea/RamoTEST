<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <title>iwms</title>
    <style>
        .nav-item a{ font-family:"微软雅黑"}
        .space{
            display: inline-block;
            padding: .5em 1em;
        }
        .navbar-nav{
            display: inline-block;
            padding: 0.5em 10em;

        }
        .form-inline{


            padding: .5em 4em;
        }

        .cebianlan{font-family:"微软雅黑";color: aliceblue;text-align: center;

        }

    </style>

</head>

<body>
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link rel="stylesheet" href="/css/bootstrap.min.css">
<link href='/css/fullcalendar.css' rel='stylesheet' />
<link href='/css/fullcalendar.print.css' rel='stylesheet' media='print' />
<link rel="stylesheet" href="http://static.runoob.com/assets/js/jquery-treeview/jquery.treeview.css" />



<script src="/js/jquery-3.3.1.min.js"></script>
<script src="/js/popper.min.js"></script>
<script src="/js/bootstrap.min.js"></script>
<script src="http://static.runoob.com/assets/js/jquery-treeview/jquery.treeview.js" type="text/javascript"></script>


<script type="text/javascript" src="js/layer/layer.js"></script>
<script type="text/javascript" src="js/context/context.js"></script>
<script type="text/javascript" src="js/drag.js" ></script>
<link rel="stylesheet" type="text/css" href="js/context/context.standalone.css">

<link rel="stylesheet" href="//code.jquery.com/ui/1.10.4/themes/smoothness/jquery-ui.css">

<script src="//code.jquery.com/ui/1.10.4/jquery-ui.js"></script>




<style type="text/css">
    .list{margin:0;padding:0;font:14px/1.5em simsun;overflow:hidden;}
    #canvas{position:absolute;z-index:9;border:2px dashed #ccc;padding:10px;background:#fff;height: 80%;width: 80%;}
    .transparent{filter:alpha(opacity=50);-moz-opacity:0.5;-khtml-opacity:0.5;opacity:0.5;}
    .box{width:200px;height:100px;cursor:move;position:absolute;top:30px;left:30px;z-index:99;}
    .box .bg{width:100%;height:100%;background-color:orange;}
    .box .coor{width:10px;height:10px;overflow:hidden;cursor:se-resize;position:absolute;right:0;bottom:0;background-color:red;}
    .box .content{position:absolute;left:50%;top:50%;z-index:99;text-align:center;font:bold 14px/1.5em simsun;}
    #toolbar{position:absolute;left:10px;top:10px;z-index:88;}


</style>


<script>




    $(document).ready(function() {
        // 首先获取当前参数
        var Request = new Object();
        Request = GetRequest();
        var user_name = Request['user_name'];
        var url = Request['url'];
        var logintl_id = Request['logintl_id'];
        var nickname = Request['nickname'];
        var image_file = Request['image_file'];
        $("#nkn").text(nickname + "");
        $("#touxiang").attr('src', image_file);
        var data1 = JSON.stringify({"logintl_id": logintl_id});

        if (user_name == null) {
            window.location.href = "http://http://114.115.172.113/login";
        }

        $("#bt_jh").click(function () {
            window.location.href="http://http://114.115.172.113/h"+"?user_name="+user_name+"&logintl_id="+logintl_id+"&nickname="+nickname+"&image_file="+image_file;;
        });
        $("#bt_kb").click(function () {
            window.location.href="http://http://114.115.172.113/broad"+"?user_name="+user_name+"&logintl_id="+logintl_id+"&nickname="+nickname+"&image_file="+image_file;;
        });
        $("#bt_set").click(function () {
            window.location.href="http://http://114.115.172.113/setting"+"?user_name="+user_name+"&logintl_id="+logintl_id+"&nickname="+nickname+"&image_file="+image_file;;
        });




        // 原生数据源
        var raw_typel = [];//原生任务类型列表


        // 仓库原生数据
        var b_unit_typeinfo;
        var b_info;


        // 部门组织获取
        $.ajax({
            type:"POST",
            dataType: "JSON",
            url:"http://http://114.115.172.113/task/findsubdept",
            data:data1,
            contentType:"application/json",
            success:function(result,status){
                var task_object=result;
                //嵌入部门标签
                for(i=0;i<task_object.length;i++){

                    $("#object_brower").append("<li><span  class=\"file ob\" id=\""+task_object[i].dept_id+"\">"+task_object[i].dept_name+"</span></li>");


                }
                $("#object_brower").treeview({
                    toggle: function() {
                        console.log("%s was toggled.", $(this).find(">span").text());
                    }
                });

                // 绑定部门点击事件-查看部门下面的人员
                $("span.ob").click(function(){
                    $("#object_body").empty();
                    var deptid= $(this).attr("id");

                    //人员ajax
                    var dept=JSON.stringify({"dept_id":deptid});
                    $.ajax({
                        type:"POST",
                        dataType: "JSON",
                        url:"http://http://114.115.172.113/task/findemployees",
                        data:dept,
                        contentType:"application/json",
                        success:function(result,status) {
                            var task_dept=result;
                            for(i=0;i<task_dept.length;i++) {
                                $("#object_body").append("<tr><td><input type=\"checkbox\" class=\"form-check-input taskob\"  value=\""+task_dept[i].logintl_id+"\" ></td><td>" +task_dept[i].nickname+"</td></tr>");

                            }
                        }});

                    $("#object_tj").click(function () {
                        var rs_taskob="";
                        $(".taskob").each(function () {
                            if($(this).prop("checked")!=false){
                                rs_taskob=rs_taskob+$(this).val()+",";
                            };
                        });
                        rs_taskob=rs_taskob.substr(0, rs_taskob.length - 1);
                        $("#t_object").val(rs_taskob);
                    });


                });
            },
            error:function () {
            }
        });


        // 悬浮窗
        $.ajax({
            type: "GET",
            dataType: "JSON",
            url: "http://http://114.115.172.113/board/allboards",
            async: false,
            contentType: "application/json",
            success: function (result) {
                b_unit_typeinfo = result.b_unit_typeinfo;
                b_info = result.b_info;
                for (i = 0; i < b_info.length; i++) {
                    var ckherf = $("<a class=\"dropdown-item bchoose\" id='" + b_info[i].b_id + "'>" + b_info[i].b_name + "</a>");
                    $("#ckxz").append(ckherf);
                }



            }

        });


        $(".bchoose").click(function () {
            $(".box").each(function(){$(this).remove();});
            //获取看板信息
            var bchoose = JSON.stringify({"b_id": $(this).attr("id")});
            $.ajax({
                type: "POST",
                dataType: "JSON",
                data: bchoose,
                url: "http://http://114.115.172.113/board/chooseboard",
                contentType: "application/json",
                success: function (result) {
                    var b_show = result.b_show;
                    var b_bg = (result.b_bg)[0];
                    $("#bg").attr("src", b_bg.bg_pic);

                    var broadshow = [];
                    for (i = 0; i < b_show.length; i++) {
                        var ob_id;
                        var ob_text;
                        var ob_color;
                        var height;
                        var width;
                        var pageX;
                        var pageY;

                        ob_id = b_show[i].unit_id;

                        for (j = 0; j < b_unit_typeinfo.length; j++) {
                            if (b_show[i].unit_typeid == b_unit_typeinfo[j].unit_typeid) {
                                ob_text = b_unit_typeinfo[j].unit_typename + ":" + b_show[i].unit_id;
                                // 单元图片
                                b_unit_typeinfo[j].pic_location;

                                break;
                            }
                        }


                        // 这里要改
                        //  注意这里的高宽要转换成int，这里的xy坐标也要讲字符串变成int
                        ob_color = "rgb(255, 0, 0)";
                        height = 51;
                        width = 72;

                        pageX = parseInt((b_show[i].b_location).split(",")[0]);
                        pageY = parseInt((b_show[i].b_location).split(",")[1]);
                        var unit = {
                            id: ob_id,
                            text: ob_text,
                            color: ob_color,
                            height: height,
                            width: width,
                            pageX: pageX,
                            pageY: pageY
                        };
                        broadshow.push(unit);

                    }
                    $("#ckm").show();
                    $('article').draggable();
                    broad(broadshow);

                    $("#ckinfo").empty();
                    // 这里调用整个仓库仓位信息给悬浮窗
                    $.ajax({
                        type: "POST",
                        dataType: "JSON",
                        url: "http://http://114.115.172.113/board/xuanfu",
                        data: bchoose,
                        async: false,
                        contentType: "application/json",
                        success: function (result) {
                            var xf = result;
                            var whs = [];
                            var biaozhi = false;
                            for (i = 0; i < xf.length; i++) {
                                biaozhi = false;
                                for (j = 0; j < whs.length; j++) {
                                    if (xf[i].whs_id == whs[j]) {
                                        biaozhi = true;
                                        break;
                                    }
                                }
                                if (biaozhi) {
                                    continue;
                                }
                                whs.push(xf[i].whs_id);
                                var biaoqian = $("<tr id='" + xf[i].whs_id + "x" + "'><td><input style='margin-left: 20px' id='" + xf[i].whs_id + "'  type='checkbox' class='form-check-input  ckall'/></td><td>" + xf[i].whs_id + "</td></tr>");
                                $("#ckinfo").append(biaoqian);

                            }

                            for (i = 0; i < xf.length; i++) {
                                if (xf[i].is_lock == "true") {
                                    var lockstyle = "style='color:red'";

                                } else {
                                    var lockstyle = "";


                                }

                                var biaoqian_zi = $("<tr " + lockstyle + "><td><input type='checkbox' whsid='"+ xf[i].whs_id+"' matlid='"+xf[i].matl_id+"' style='margin-left: 20px' class='form-check-input matl " + xf[i].whs_id + "'/></td><td></td><td>" + xf[i].matl_id + "</td><td><input style='width: 100px' type=\"text\" class=\"form-control \" id='" + xf[i].whs_id + "_"+xf[i].matl_id+ "'></td><td>" + xf[i].quantity + xf[i].danwei + "</td><td>" + xf[i].picihao + "</td><td></td></tr>");
                                $("#" + xf[i].whs_id + "x").after(biaoqian_zi);
                            }
                        }
                    });


                    // 悬浮窗口选中改选事件
                    $(".ckall").change(function () {
                        var id = $(this).attr("id");
                        if ($(this).prop("checked") == true) {
                            $("." + ($(this).attr("id"))).each(function () {

                                $(this).prop("checked", true);
                            });
                            $(".box").each(function () {
                                if ($(this).attr("dataid") == id) {
                                    $(this).click();
                                }
                            });


                        } else {
                            $("." + ($(this).attr("id"))).each(function () {
                                $(this).prop("checked", false);
                            });
                            $(".box").each(function () {
                                if ($(this).attr("dataid") == id) {
                                    $(this).css("border", "0px none rgb(33, 37, 41)");
                                }
                            });


                        }
                    });


                    // 选中仓位
                    $(".box").click(function () {
                        if (($(this).css("border")).indexOf("0") != "0") {
                            $(this).css("border", "0px none rgb(33, 37, 41)");
                            var quxiao = $(this).attr("dataid");
                            $('#' + quxiao).prop("checked", false);
                        } else {
                            $(this).css("border", "#FFFF00 solid");
                            var xuanze = $(this).attr("dataid");
                            $('#' + xuanze).prop("checked", true);
                        }

                    });

                }
            });

        });


        // 任务类型
        $.ajax({
            type: "GET",
            dataType: "JSON",
            url: "http://http://114.115.172.113/task/typelist",
            async: false,
            contentType: "application/json",
            success: function (result) {
                raw_typel = result;
                for (var i = 0; i < result.length; i++) {
                    var biaoqian1 = $("<a class=\"dropdown-item \" href=\"#\">" + result[i].t_name + "</a>");
                    var biaoqian2 = $("<a class=\"dropdown-item btn newtask btn-primary\"  data-toggle=\"modal\" data-target=\"#myModal2\" id=\"" + result[i].t_typeid + "\" >" + result[i].t_name + "</a>");

                    $("#renwulie1").append(biaoqian1);
                    $("#renwulie_1").append(biaoqian2);

                }

                // 任务类型填写
                $(".newtask").click(function () {
                    $("#t_typeid").val($(this).attr("id"));
                    $("#t_creator").val(logintl_id);
                });


            }

        });

        // 任务提交
        $("#sub").click(function () {
            var jsonuserinfo = $("#formDemo").serializeObject();
            // jsonuserinfo.t_req_ftime= new Date(jsonuserinfo.t_req_ftime);
            // jsonuserinfo.t_req_stime= new Date(jsonuserinfo.t_req_stime);
            jsonuserinfo.is_divide = $("#is_divide").prop("checked");
            var formjson = JSON.stringify(jsonuserinfo);
            $.ajax({
                type: "POST",
                dataType: "JSON",
                url: "http://http://114.115.172.113/task/newtask",
                data: formjson,
                contentType: "application/json",
                success: function (result, status) {
                    alert(result.message);
                    location.reload();
                },
                error: function () {

                }


            });
        });

        //form转json
        $.fn.serializeObject = function () {
            var o = {};
            var a = this.serializeArray();
            $.each(a, function () {
                if (o[this.name]) {
                    if (!o[this.name].push) {
                        o[this.name] = [o[this.name]];
                    }
                    o[this.name].push(this.value || '');
                } else {
                    o[this.name] = this.value || '';
                }
            });
            return o;
        };


        // 默认选择当前日期显示任务看板
        // 日期加减函数（停用）
        // function addDate(date,days){
        //     var d=new Date(date);
        //     d.setDate(d.getDate()+days);
        //     var month=d.getMonth()+1;
        //     var day = d.getDate();
        //     if(month<10){
        //         month = "0"+month;
        //     }
        //     if(day<10){
        //         day = "0"+day;
        //     }
        //     var val = d.getFullYear()+"/"+month+"/"+day;
        //     return val;
        // }
        // var myDate = new Date();
        // var beforeday=addDate(myDate,-7);
        // var viewdate=beforeday+"-"+myDate.toLocaleDateString();
        // $("#data").text(viewdate);
        // // 日期初始化
        // $("#data").click(function () {
        //     var myDate = new Date();
        //     var beforeday=addDate(myDate,-7);
        //     var viewdate=beforeday+"-"+myDate.toLocaleDateString();
        //     $("#data").text(viewdate);
        // });
        // // 日期前进按钮
        // $("#qian").click(function(){
        //     // 字符串转日期
        //     var dangqian= $("#data").text();
        //     var days= new Date(Date.parse( dangqian.split("-")[0].replace(/-/g,"/")));
        //     var beforeday=addDate(days,-7);
        //     var viewdate=beforeday+"-"+days.toLocaleDateString();
        //     $("#data").text(viewdate);
        // });
        //     // 日期后退按钮
        // $("#hou").click(function () {
        //     // 字符串转日期
        //     var dangqian= $("#data").text();
        //     var days= new Date(Date.parse( dangqian.split("-")[1].replace(/-/g,"/")));
        //     var beforeday=addDate(days,7);
        //     var viewdate=days.toLocaleDateString()+"-"+beforeday;
        //     $("#data").text(viewdate);
        // });
        //

        $("#btn_lock").trigger("click")
        $("#t_content").hide();
        $(".hied").hide();
        $("#t_object").hide();
        $(".hidecq").hide();
        $("#lasheng").click(function () {
            $("#ck_meau").fadeToggle();
        });
        $("#ckm").hide();



        // 任务锁仓位
        $("#lockwhs_task").click(function () {

            $(".ckall").each(function () {

                if ($(this).prop("checked")) {
                    var lockwhs = JSON.stringify({"logintl_id": logintl_id, "whs_id": ($(this).attr("id") + "")});
                    $.ajax({
                        type: "POST",
                        dataType: "JSON",
                        data: lockwhs,
                        url: "http://http://114.115.172.113/board/lockwhs",
                        contentType: "application/json",
                        success: function (result) {
                            $("#titile_success").show();
                            $("#success").text(result.message);
                        }
                    });


                }
            });
        });

        // 任务解锁仓位
        $("#unlockwhs_task").click(function () {
            $(".ckall").each(function () {
                if ($(this).prop("checked")) {
                    var unlockwhs = JSON.stringify({"whs_id": ($(this).attr("id") + "")});
                    $.ajax({
                        type: "POST",
                        dataType: "JSON",
                        data: unlockwhs,
                        url: "http://http://114.115.172.113/board/unlockwhs",
                        contentType: "application/json",
                        success: function (result) {
                                $("#titile_success").show();
                                $("#success").text(result.message);
                            $("#titile_success").fadeOut(3000);
                        }
                    });
                }
            });
        });

        // 物品加锁
        $("#lockmatl_task").click(function () {
            $(".matl").each(function () {
                if ($(this).prop("checked")) {
                   var whsid =$(this).attr('whsid');
                   var matlid=$(this).attr('matlid');
                    var lockmatl_task = JSON.stringify({"whs_id":whsid,"matl_id":matlid,"logintl_id":logintl_id});
                    console.log(lockmatl_task);
                    $.ajax({
                        type: "POST",
                        dataType: "JSON",
                        data: lockmatl_task,
                        url: "http://http://114.115.172.113/board/lockmatl",
                        contentType: "application/json",
                        success: function (result) {
                            $("#titile_success").show();
                            $("#success").text(result.message);
                            $("#titile_success").fadeOut(3000);

                        }
                    });


                }


            });
            location.reload();

        });

        // 物品解锁
        $("#unlockmatl_task").click(function () {
            $(".matl").each(function () {
                if ($(this).prop("checked")) {
                    var whsid =$(this).attr('whsid');
                    var matlid=$(this).attr('matlid');
                    var unlockmatl = JSON.stringify({"whs_id":whsid,"matl_id":matlid});
                    console.log(unlockmatl);
                    $.ajax({
                        type: "POST",
                        dataType: "JSON",
                        data: unlockmatl,
                        url: "http://http://114.115.172.113/board/unlockmatl",
                        contentType: "application/json",
                        success: function (result) {
                            $("#titile_success").show();
                            $("#success").text(result.message);
                            $("#titile_success").fadeOut(3000);

                        }
                    });


                }


            });

            location.reload();
        });

        // 任务提交
        $("#sub").click(function () {
            var jsonuserinfo = $("#formDemo").serializeObject();
            // jsonuserinfo.t_req_ftime= new Date(jsonuserinfo.t_req_ftime);
            // jsonuserinfo.t_req_stime= new Date(jsonuserinfo.t_req_stime);
            jsonuserinfo.is_divide=$("#is_divide").prop("checked");
            var formjson=JSON.stringify(jsonuserinfo);
            $.ajax({
                type:"POST",
                dataType: "JSON",
                url:"http://http://114.115.172.113/task/newtask",
                data:formjson,
                contentType:"application/json",
                success:function(result,status){alert(result.message) ;
                    location.reload();},
                error:function () {

                }


            });
        });

        // 这里是物品组织表获取
        $.ajax({
            type:"POST",
            dataType: "JSON",
            url:"http://http://114.115.172.113/task/matlstruct",
            data:data1,
            contentType:"application/json",
            success:function(result,status){
                var wupinlist=result;
                var mulunum=0;
                for(i=0;i<wupinlist.length;i++)
                {
                    if(wupinlist[i].is_mulu==true){mulunum=mulunum+1;}
                    if(wupinlist[i].matl_structparent==""&&wupinlist[i].is_mulu==true)
                    {

                        $("#browser").append("<li><span class=\"folder\" >"+wupinlist[i].matl_structname+"</span><ul id=\""+wupinlist[i].matl_structname+"\" ></ul></li>");
                        mulunum=mulunum-1;
                    }
                }
                for(;mulunum!=0;){
                    for(i=0;i<wupinlist.length;i++)
                    {
                        if(wupinlist[i].matl_structparent!=""&&wupinlist[i].is_mulu==true)
                        {

                            $("#"+wupinlist[i].matl_structparent).append("<li><span class=\"folder\" >"+wupinlist[i].matl_structname+"</span><ul id=\""+wupinlist[i].matl_structname+"\" ></ul></li>");
                            mulunum=mulunum-1;
                        }
                    }
                }
                for(i=0;i<wupinlist.length;i++)
                {
                    if(wupinlist[i].matl_structparent!=""&&wupinlist[i].is_mulu==false)
                    {
                        $("#"+wupinlist[i].matl_structparent).append("<li><span class=\"file matl\" id=\""+wupinlist[i].matl_structid+"\" >"+wupinlist[i].matl_structname+"</span></li>");
                    }
                }
                $("span.matl").click(function(){

                    $("#whs_record").empty();

                    var  matl_structid=$(this).attr("id")+"";
                    var matl_name=$(this).text();
                    var wuliaoid=JSON.stringify({"matl_id":matl_structid});
                    $.ajax({
                        type:"POST",
                        dataType: "JSON",
                        url:"http://http://114.115.172.113/task/findwhsbymatl",
                        data:wuliaoid,
                        contentType:"application/json",
                        success:function(result,status){

                            for(i=0;i<result.length;i++){

                                var tim=formatDateTime(result[i].wh_intime);
                                // $("#whs_record").append("<tr><td>"+result[i].whs_id+"</td><td>"+result[i].matl_id+"</td><td>"+matl_name+"</td><td>"+result[i].difference1+"</td><td>"+ result[i].difference2+"</td><td>"+result[i].quantity+"</td><td>"+result[i].danwei+"</td><td>"+ result[i].wh_intime+"</td><td>"+ result[i].wh_intime+"</td><td>"+ result[i].is_matllock+"</td><td>"+ result[i].lock_id+"</td><td>"+ result[i].pr_id+"</td><td>"+result[i].matl_statusid+"</td><td>"+ result[i].picihao+"</td></tr>")
                                $("#whs_record").append("<tr> <td><input type=\"checkbox\" class=\"form-check-input checkmalts\"  value=\"recordtl_id:"+result[i].recordtl_id+"%whs_id:"+result[i].whs_id+"%matl_id:"+result[i].matl_id+"\" ></td><td><input type=\"text\" class=\"form-control col-md-3 \" id=\""+result[i].recordtl_id+"\"></td><td>"+result[i].whs_id+"</td><td>"+result[i].matl_id+"</td><td>"+matl_name+"</td><td>"+result[i].quantity+"</td><td>"+result[i].danwei+"</td><td>"+tim+"</td></tr>");
                            }
                            $("#matl_tj").click(function(){
                                var rs="";
                                var view="";
                                $(".checkmalts").each(function(){
                                    if($(this).prop('checked')!=false){

                                        rs=rs+$(this).val()+"|";
                                        var text=($(this).val().split(":")[1]).split("%")[0];
                                        rs=rs+"num:"+$("#"+text).val()+"@";

                                        var viewlist=[];
                                        viewlist=$(this).val().split("%");
                                        view=view+"仓位:"+viewlist[0].split(":")[1]+" 物品id:"+viewlist[1].split(":")[1]+" 数量："+$("#"+text).val();

                                    }
                                });
                                $("#t_content").val(rs);


                                $("#t_cont").val(view);
                            });
                        },
                        error:function () {

                        }
                    });
                });
                $("#browser").treeview({
                    toggle: function() {
                        console.log("%s was toggled.", $(this).find(">span").text());
                    }
                });
            },
            error:function () {
            }
        });

        var whsstatus=null;
        // 仓位组织获取
        $.ajax({
            type:"GET",
            dataType: "JSON",
            url:"http://http://114.115.172.113/task/findwhstructure",
            contentType:"application/json",
            success:function(whsresult,status){
                var whslist=whsresult;
                // 嵌入库标签
                for(i=0;i<whslist.length;i++)
                {
                    if(whslist[i].wh_parent=="K"||whslist[i].wh_parent=="G")
                    {
                        $("#out_brower").append("<li><span  class=\"folder\" >"+whslist[i].wh_name+"</span><ul id=\""+whslist[i].wh_id+"\"></ul></li>");
                    }
                }

                // 嵌入库区标签
                for(i=0;i<whslist.length;i++){
                    if(whslist[i].wh_parent!=""&&whslist[i].is_mulu==true)
                    {
                        $("#"+whslist[i].wh_parent).append("<li><span  class=\"file wh\" id=\""+whslist[i].wh_id+"\">"+whslist[i].wh_name+"</span></li>");

                    }
                }

                $("#out_brower").treeview({
                    toggle: function() {
                        console.log("%s was toggled.", $(this).find(">span").text());
                    }
                });

                // 绑定库区点击事件-查看库区下面的仓位
                $("span.wh").click(function(){
                    $("#in_out").empty();

                    //先上仓位

                    var kuid= $(this).attr("id");
                    var jieshubiaozhi=false;
                    for(i=0;i<whslist.length;i++){
                        if( whslist[i].wh_parent==kuid)
                        {
                            for(k=0;k<whsstatus.length;k++)
                            {
                                if(whsstatus[k].whs_id==whslist[i].wh_id)
                                {
                                    $("#in_out").append("<tr><td><input type=\"checkbox\" class=\"form-check-input checkwhs\"  value=\"whs_id:"+whsstatus[k].whs_id+"\" ></td><td>"+whsstatus[k].whs_id+"</td><td>"+whsstatus[k].whs_wanringid+"</td><td>"+whsstatus[k].vol_percent+"</td><td>"+whsstatus[k].whs_availvol+"</td><td>"+whsstatus[k].whs_allvol+"</td></tr>");
                                    jieshubiaozhi=true;
                                    break;
                                }
                            }
                            if(jieshubiaozhi)break;
                        }
                    }
                    $("#weizhi_tj").click(function () {
                        $(".checkwhs").each(function () {
                            if($(this).prop("checked")!=false){
                                var rs_whs=$(this).val()+"@";
                                $("#t_content").val(rs_whs);
                                alert($(this).val());

                                $("#t_cont").val("仓位："+($(this).val()).split(":")[1]);
                            };
                        });

                    });
                });
            },
            error:function () {
            }
        });


        // 仓位获取
        $.ajax({
            type:"GET",
            dataType: "JSON",
            url:"http://http://114.115.172.113/task/whsstatus",
            contentType:"application/json",
            success:function(result,status){
                whsstatus = result;
            }});




        // 出库任务
        $("#out").click(function () {
            $("#t_typeid").val("1");
            $("#cwbt").hide();
            var view="";
            var rs="";
            $(".matl").each(function () {
                if ($(this).prop("checked")) {
                    var whsid = $(this).attr('whsid');
                    var matlid = $(this).attr('matlid');
                    var num=$("#"+whsid+"_"+matlid).val();
                    view=view+"仓位:"+whsid+" 物品id:"+matlid+" 数量："+num+" ";
                    rs=rs+"whs_id:"+whsid+"%"+"matl_id:"+matlid+"|"+num+"@";
                }
            });
            $("#t_content").val(rs);
            $("#t_cont").val(view);
        });

        // 入库任务
        $("#in").click(function () {
            $("#t_typeid").val("2");
            $("#cwbt").show();
        });


    });


    // 时间格式转换函数
    function formatDateTime(inputTime) {
        var date = new Date(inputTime);
        var y = date.getFullYear();
        var m = date.getMonth() + 1;
        m = m < 10 ? ('0' + m) : m;
        var d = date.getDate();
        d = d < 10 ? ('0' + d) : d;
        var h = date.getHours();
        h = h < 10 ? ('0' + h) : h;
        var minute = date.getMinutes();
        var second = date.getSeconds();
        minute = minute < 10 ? ('0' + minute) : minute;
        second = second < 10 ? ('0' + second) : second;
        return y + '-' + m + '-' + d+' '+h+':'+minute+':'+second;
    };

    // 获取url参数
    function GetRequest() {

        var url = decodeURI(location.search); //获取url中"?"符后的字串
        var theRequest = new Object();
        if (url.indexOf("?") != -1) {
            var str = url.substr(1);
            strs = str.split("&");
            for(var i = 0; i < strs.length; i ++) {
                theRequest[strs[i].split("=")[0]]=unescape(strs[i].split("=")[1]);
            }
        }
        return theRequest;
    }

    // 看板显示
    function broad(broadshow){

        //初始化计数器
        var num = 0;
        //区块锁定标识
        var lock = false;
        //加载layer拓展
        layer.config({
            extend: 'extend/layer.ext.js'
        });
        //右键菜单参数
        context.init({
            fadeSpeed: 100,
            filter: function ($obj){},
            above: 'auto',
            preventDoubleContext: true,
            compress: false
        });
        //调试输出方法
        function debug(msg){
            $("#debug").text(msg);
        }
        function createBox(data){
            var dataId = data.id || '';
            var value = data.text || '';
            var color = data.color || '';
            var height = data.height || 0;
            var width = data.width || 0;
            var pageX = data.pageX || 0;
            var pageY = data.pageY || 0;

            //更新计数器并记录当前计数
            var curNum = num++;
            //创建区域块
            var pos = $("#canvas").position();
            var box = $('<div class="box" rel="'+curNum+'" dataId="'+dataId+'"><pre class="content">'+value+'</pre><div class="bg transparent" style="background-color:'+color+'"></div><div class="coor transparent"></div></div>').css({
                width : width,
                height : height,
                top : pageY > 0 ? pageY : (pos.top > 0 ? 0 : pos.top * -1 + 50),
                left : pageX > 0 ? pageX : (pos.left > 0 ? 0 : pos.left * -1 + 30)
            }).appendTo("#canvas");

            //计算文本位置
            box.find('.content').css({
                marginLeft : box.find('.content').width()/2*-1,
                marginTop : box.find('.content').height()/2*-1
            });
            //创建右键菜单
            context.attach('.box[rel='+curNum+']', [
                {header: '操作'},
                {text: '编辑区域说明', action: function(e){
                        e.preventDefault();
                        layer.prompt({
                            title: '请输入区域说明',
                            formType: 2,
                            value: $('.box[rel='+curNum+'] .content').text()
                        }, function(value, index, elem){
                            layer.close(index);
                            var curCont = $('.box[rel='+curNum+'] .content');
                            curCont.text(value).css({
                                marginLeft : curCont.width()/2*-1,
                                marginTop : curCont.height()/2*-1
                            });
                        });
                    }
                },
                {text: '更改区域尺寸', action: function(e){
                        e.preventDefault();
                        layer.prompt({
                            title: '请输入区域尺寸（宽,高），最小值：30',
                            formType: 0,
                            value: $('.box[rel='+curNum+']').width()+","+$('.box[rel='+curNum+']').height()
                        }, function(value, index, elem){
                            var reg = /^[0-9]+,[0-9]+$/;
                            if(!reg.test(value)){
                                alert('输入格式不正确，例：100,200');
                                return;
                            }
                            var size = value.split(',');
                            var box = $('.box[rel='+curNum+']');
                            box.css({
                                width : size[0] < 30 ? 30 : size[0],
                                height : size[1] < 30 ? 30 : size[1]
                            });
                            layer.close(index);
                        });
                    }
                },
                {text: '删除区域', action: function(e){
                        e.preventDefault();
                        $('.box[rel='+curNum+']').remove();
                    }
                },
                {divider: true},
                {header: '更改颜色'},
                {text: '<font color="orange">橙色</font>', action: function(e){
                        e.preventDefault();
                        $('.box[rel='+curNum+'] .bg').css('background-color', 'orange');
                    }
                },
                {text: '<font color="red">红色</font>', action: function(e){
                        e.preventDefault();
                        $('.box[rel='+curNum+'] .bg').css('background-color', 'red');
                    }
                },
                {text: '<font color="blue">蓝色</font>', action: function(e){
                        e.preventDefault();
                        $('.box[rel='+curNum+'] .bg').css('background-color', 'blue');
                    }
                },
                {text: '<font color="green">绿色</font>', action: function(e){
                        e.preventDefault();
                        $('.box[rel='+curNum+'] .bg').css('background-color', 'green');
                    }
                },
                {text: '<font color="purple">紫色</font>', action: function(e){
                        e.preventDefault();
                        $('.box[rel='+curNum+'] .bg').css('background-color', 'purple');
                    }
                },
                {text: '<font color="yellow">黄色</font>', action: function(e){
                        e.preventDefault();
                        $('.box[rel='+curNum+'] .bg').css('background-color', 'yellow');
                    }
                }
            ]);
        }
        //添加区域
        $("#btn_add").click(function(){
            //弹出区域说明输入框
            layer.prompt({
                title: '请输入区域说明',
                formType: 2 //0:input,1:password,2:textarea
            }, function(value, index, elem){
                layer.close(index);
                createBox({
                    text : value,
                    width : 200,
                    height : 100
                });
            });
        });
        //锁定区域
        $('#btn_lock').click(function(){
            if(lock){
                $(this).val("锁定区域");
                lock = false;
                $('.box .coor').show();
            }else{
                $(this).val("解锁区域");
                lock = true;
                $('.box .coor').hide();
            }
        });
        //获取所有区块
        $('#btn_save').click(function(){
            var data = [];
            $('.box').each(function(){
                var box = {};
                box['id'] = $(this).attr('dataId');
                box['text'] = $(this).find('.content').text();
                box['color'] = $(this).find('.bg').css('background-color');
                box['height'] = $(this).height();
                box['width'] = $(this).width();
                box['pageX'] = $(this).position().left;
                box['pageY'] = $(this).position().top;
                console.dir(box);
                data.push(box);
            });
        });
        //创建拖拽方法
        $("#canvas").mousedown(function(e){
            var canvas = $(this);
            e.preventDefault();
            var pos = $(this).position();
            this.posix = {'x': e.pageX - pos.left, 'y': e.pageY - pos.top};
            $.extend(document, {'move': true, 'move_target': this, 'call_down' : function(e, posix){
                    canvas.css({

                    });
                }, 'call_up' : function(){

                }});
        }).on('mousedown', '.box', function(e) {
            if(lock) return;
            var pos = $(this).position();
            this.posix = {'x': e.pageX - pos.left, 'y': e.pageY - pos.top};
            $.extend(document, {'move': true, 'move_target': this});
            e.stopPropagation();
        }).on('mousedown', '.box .coor', function(e) {
            var $box = $(this).parent();
            var posix = {
                'w': $box.width(),
                'h': $box.height(),
                'x': e.pageX,
                'y': e.pageY
            };
            $.extend(document, {'move': true, 'call_down': function(e) {
                    $box.css({
                        'width': Math.max(30, e.pageX - posix.x + posix.w),
                        'height': Math.max(30, e.pageY - posix.y + posix.h)
                    });
                }});
            e.stopPropagation();
        });
        //测试加载
        var loadData =broadshow;
        $.each(loadData, function(i, row){
            createBox(row);
        });

        $("#btn_lock").click();
    };





</script>


<nav class="navbar navbar-expand-sm bg-dark navbar-dark ">
    <ul class="navbar-nav">


        <li class="nav-item"    style="margin-left:30px; ">
            <img class="image-responsive" src="/images/logo.png"   height="50" width="80"  alt="logo"/>
        </li>


        <li class="nav-item" style="margin-left:30px;margin-top:15px;">
            <a class="navbar-brand" href="#" style="font-size: 14pt">动态仓存管理系统</a>
        </li>
    </ul>


    <div class="collapse navbar-collapse justify-content-end" id="navbarSupportedContent" >
        <ul class="navbar-nav" id="headerNav" >
            <form class="form-inline" role="search">
                <div class="space" style="">
                    <input type="text" class="form-control" placeholder="Search">
                </div>
                <button type="submit" class="btn btn-default" >Submit</button>
            </form>

            <img class="img-circle image-responsive" src="/images/pic.png" style=" border-radius:50%;margin-top: 15px;"  height="40" width="40"  alt="头像" id="touxiang"/>

            <ul class="nav nav-pills">
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" data-toggle="dropdown" href="#" style="color: aliceblue;margin-top: 15px" id="nkn"></a>
                    <div class="dropdown-menu">
                        <a class="dropdown-item" href="#">个人中心</a>
                        <a class="dropdown-item" href="#">服务购买</a>
                        <a class="dropdown-item" href="#">退出</a></div>
                </li>
            </ul>
        </ul>
    </div>

</nav>


<div>
    <ul class="navbar-nav nav-pills navitem   col-md-2" style="height: 860px;float: left;background:#465269;padding-bottom: 0;padding-right: 0;">

        <li class="nav-item" >
            <iframe width="100%" scrolling="no" height="60" frameborder="0" allowtransparency="true" src="http://i.tianqi.com/index.php?c=code&id=12&color=%23FFFFFF&bdc=%23&icon=3&num=1&site=12" style="padding-left: 10% "></iframe>
        </li>
        <li class="nav-item">

            <a class="nav-link  cebianlan" href="#"> <img class=" image-responsive" src="images/状态F.png" style="margin-right: 20px" height="40px" width="40px"  alt="状态"/> 状态仪表</a>
        </li>
        <li class="nav-item ">
            <a class="nav-link cebianlan " href="#" id="bt_jh"><img class=" image-responsive" src="images/任务计划.png" style="margin-right: 20px" height="40px" width="40px"  alt="状态"/>任务计划</a>
        </li>
        <li class="nav-item">
            <a class="nav-link cebianlan" href="#" id="bt_kb"><img class=" image-responsive" src="images/看板.png"  style="margin-right: 20px"height="40px" width="40px"  alt="状态"/>看&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;板</a>
        </li>
        <li class="nav-item">
            <a class="nav-link cebianlan" href="#"><img class=" image-responsive" src="images/项目.png" style="margin-right: 20px" height="40px" width="40px"  alt="状态"/>项&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;目</a>
        </li>
        <li class="nav-item">
            <a class="nav-link cebianlan" href="#"><img class=" image-responsive pull-left"  style="margin-right: 20px" src="images/报表日志.png"  height="40px" width="40px"  alt="状态"/>报表日志</a>
        </li>
        <li class="nav-item  " >

            <a class="nav-link cebianlan" href="#" id="bt_set"><img class=" image-responsive" style="margin-right: 20px"  src="images/设置.png"  height="40px" width="40px"  alt="状态"/>设&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;置</a>
        </li>
    </ul>





</div>

<div class="list">


    <div id="toolbar" style="left:318px;top:103px;"  >



        <div class="btn-group">
                <!--<button type="button" class="btn btn-primary"   id="btn_add">添加区域</button>-->
                <button type="button" class="btn btn-primary hied"   id="btn_lock" >锁定区域</button>

                <!--<button type="button" class="btn btn-primary"   id="btn_save" >获取数据</button>-->
                <div class="btn-group">
                    <button type="button" class="btn btn-primary dropdown-toggle" data-toggle="dropdown">
                       仓库选择
                    </button>
                    <div class="dropdown-menu" id="ckxz">

                    </div>
                </div>
        </div>
        <div class="row clearfix hied" id="titile_success">
            <div class="col-md-12 column">
                <div class="alert alert-success alert-dismissable fade show" id="success">
                    <button type="button" class="close" data-dismiss="alert">&times;</button>
                    <strong>成功!</strong> 指定操作成功提示信息。
                </div>
            </div>
        </div>
        <div class="row clearfix hied" id="titile_error">
            <div class="col-md-12 column">
                <div class="alert alert-danger alert-dismissable fade show" id="error">
                    <button type="button" class="close" data-dismiss="alert">&times;</button>
                    <strong>错误!</strong> 失败的操作。
                </div>
            </div>
        </div>



        <article id="ckm" style="  width:500px;position: absolute;top: 100px; left: 40px;background: inherit;border-radius: 6px;-webkit-box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);overflow: hidden; ">
            <div class="title" style=" height:60px;padding: 8px;background: rgba(225, 225, 225, 0.5);border-bottom: 1px solid rgba(0, 0, 0, 0.05);text-align: center;">
                <h2 style=" font: 14px/1.2 'Helvetica Neue', Helvetica, sans-serif;">
                    <table class="table">
                        <thead>
                        <tr>
                            <!--<th>仓位</th>-->
                            <!--<th>物品</th>-->
                            <!--<th>数量</th>-->
                            <!--<th>批次</th>-->
                            <th>
                                <div class="btn-group">
                                    <button id="lasheng" type="button" class="btn btn-outline-light text-dark">收</button>
                                    <div class="btn-group">
                                        <button type="button" class="btn btn-outline-light text-dark dropdown-toggle" data-toggle="dropdown">
                                            任务
                                        </button>
                                        <div class="dropdown-menu">
                                            <a class="dropdown-item" id="lockwhs_task">锁仓</a>
                                            <a class="dropdown-item" id="lockmatl_task">锁物料</a>
                                            <a class="dropdown-item" id="unlockwhs_task">解锁仓</a>
                                            <a class="dropdown-item" id="unlockmatl_task">解锁物料</a>


                                            <a class="dropdown-item" href="#"  id="out" data-toggle="modal" data-target="#myModal2">出库任务</a>
                                            <a class="dropdown-item" href="#"  id="in" data-toggle="modal" data-target="#myModal2">入库任务</a>

                                        </div>
                                    </div>
                                </div>
                            </th>
                        </tr>
                        </thead>
                        </table>
</h2>
            </div>
            <div id="ck_meau" class="content" style="  padding: 8px;background: rgba(255, 255, 255, 0.5);overflow-y:auto;  width:500px; height:400px">
                <table class="table" >
                    <thead>
                    <tr>
                        <th>选中</th>
                        <th>仓位</th>
                        <th>物品</th>
                        <th>使用数量</th>
                        <th>数量</th>
                        <th>批次号</th>
                    </tr>
                    </thead>
                    <tbody id="ckinfo">

                    </tbody>
                </table>
            </div>
        </article>


    </div>
    <div id="canvas" style="left:318px;top:103px;width: 83%;height: 860px;" >
        <img  id="bg" src="/images/broad/yobg.jpg" style="width: 100%;height: 100%;"/>
    </div>



    <div style="text-align:center;margin:50px 0; font:normal 14px/24px 'MicroSoft YaHei';">



    </div>
</div>
</div>

<!--填写任务-->
<div class="modal fade" id="myModal2">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">

            <!-- 模态框头部 -->
            <div class="modal-header bg-success">
                <h4 class="modal-title">新建任务</h4>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>

            <!-- 填写任务 -->
            <div class="modal-body">
                <div id="renwutianxie">

                    <form class="form-horizontal" role="form"  id="formDemo"  >
                        <div class="form-group " >
                            <label for="t_id" class="col-sm-2 control-label">任务号</label>
                            <div class="col-sm-4">
                                <input type="text" class="form-control" name="t_id" id="t_id" >
                            </div>
                        </div>
                        <div class="form-group hied" >
                            <label for="t_typeid" class="col-sm-2 control-label">任务类型</label>
                            <div class="col-sm-10">
                                <input type="text" class="form-control col-sm-4"  name="t_typeid" id="t_typeid" >
                            </div>
                        </div>

                        <div class="form-group hidecq" >
                            <label for="t_creator" class="col-sm-2 control-label">任务创建人</label>
                            <div class="col-sm-10">
                                <input type="text" class="form-control col-sm-4" name="t_creator" id="t_creator" >
                            </div>
                        </div>

                        <!--这是隐藏的-->
                        <div class="form-group hidecq"  >
                            <label for="t_object" class="col-sm-2 control-label">任务对象</label>
                            <div class="col-sm-10">

                                <input type="text" class="form-control col-sm-4" id="t_object" name="t_object" />
                            </div>
                        </div>



                        <div class="btn-group">
                            <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#object_modal">任务对象 </button>
                            <div class="btn-group" id="cwbt">
                                <button type="button" class="btn btn-primary dropdown-toggle" data-toggle="dropdown">
                                    基本任务内容
                                </button>
                                <div class="dropdown-menu " >
                                    <a class="dropdown-item btn btn-primary " data-toggle="modal" data-target="#out_modal" >仓位</a>
                                </div>
                            </div>
                            &nbsp<input type="text" class="form-control" name="t_content" id="t_cont" disabled="true" >
                        </div>





                        <!--这是隐藏的-->
                        <div class="form-group hidecq">
                            <label for="t_content" class="col-sm-2 control-label">任务内容</label>
                            <div class="col-sm-10">
                                <input type="text" class="form-control" name="t_content" id="t_content" >
                            </div>
                        </div>



                        <div class="form-group">
                            <label for="t_priority" class="col-sm-2 control-label">优先级</label><div class="col-sm-10">
                            <select class="form-control col-sm-4" id="t_priority" name="t_priority">
                                <option>1</option>
                                <option>2</option>
                                <option>3</option>
                                <option>4</option>
                                <option>5</option>
                            </select>
                        </div>
                        </div>



                        <div class="form-group">
                            <label for="t_info"class="col-sm-2 control-label">任务说明</label><div class="col-sm-10">
                            <textarea class="form-control" rows="5" id="t_info" placeholder="请输入任务说明（可不填）" name="t_info" ></textarea></div>
                        </div>

                    </form>




                </div>
            </div>

            <!-- 模态框底部 -->
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" id="sub">提交</button>
                <button type="button" class="btn btn-secondary"  data-dismiss="modal">关闭</button>
            </div>

        </div>
    </div>
</div>

<!--任务对象选择-->
<div class="modal fade " id="object_modal">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">

            <!-- 模态框头部 -->
            <div class="modal-header">
                <h4 class="modal-title">人员</h4>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>

            <!-- 模态框主体 -->
            <div class="modal-body">
                <ul id="object_brower" class="filetree treeview-famfamfam">

                </ul>
                <div >
                    <table class="table table-hover">
                        <thead>

                        <tr>
                            <th>选中</th>
                            <th>名称</th>
                            <th>手机</th>

                        </tr>
                        </thead>
                        <tbody id="object_body">
                        </tbody>
                    </table>
                </div>

            </div>

            <!-- 模态框底部 -->
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary i" data-dismiss="modal" id="object_tj">提交</button>
                <button type="button" class="btn btn-secondary" data-dismiss="modal" >关闭</button>
            </div>

        </div>
    </div>
</div>

<!--位置选择模态框-->
<div class="modal fade " id="out_modal">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">

            <!-- 模态框头部 -->
            <div class="modal-header">
                <h4 class="modal-title">仓位</h4>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>

            <!-- 模态框主体 -->
            <div class="modal-body">
                <ul id="out_brower" class="filetree treeview-famfamfam">

                </ul>
                <div >
                    <table class="table table-hover">
                        <thead>
                        <!--<tr>-->
                        <!--<th>仓位ID</th>-->
                        <!--<th>物品ID</th>-->
                        <!--<th>物品名称</th>-->
                        <!--<th>物料参数区别参数1</th>-->
                        <!--<th>物料参数区别参数2</th>-->
                        <!--<th>数量</th>-->
                        <!--<th>单位</th>-->
                        <!--<th>入库时间</th>-->
                        <!--<th>PR号</th>-->
                        <!--<th>物品存放状态</th>-->
                        <!--<th>批次号/BID/PID</th>-->

                        <!--</tr>-->

                        <tr>
                            <th>选中</th>
                            <th>仓位</th>
                            <th>仓位报警</th>
                            <th>仓位容积百分比</th>
                            <th>仓位可用容量</th>
                            <th>仓位总容量</th>
                        </tr>
                        </thead>
                        <tbody id="in_out">
                        </tbody>
                    </table>
                </div>


            </div>

            <!-- 模态框底部 -->
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary i" data-dismiss="modal" id="weizhi_tj">提交</button>
                <button type="button" class="btn btn-secondary" data-dismiss="modal" >关闭</button>
            </div>

        </div>
    </div>
</div>


<footer class="text-center" style="clear: both">
    <div class="container">

        <div >
            <p>Copyright © Ramo. All rights reserved.</p>
        </div>

    </div>
</footer>

</body>
</html>
